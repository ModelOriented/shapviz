<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geographic Components • shapviz</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- dalexverse --><link href="../dalexverse.css" rel="stylesheet">
<link href="../dalexverse-2.css" rel="stylesheet">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Geographic Components">
<meta property="og:description" content="shapviz">
<meta property="og:image" content="/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- google analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-5650686-14"></script><script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-5650686-14');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">shapviz</a>
        <div class="info">
          <span class="partof">part of the <a href="https://github.com/ModelOriented/DrWhy" class="external-link">DrWhy.AI</a>
           developed by the <a href="https://mi2.ai/" class="external-link">MI².AI</a> </span>
          <span class="version version-default">0.9.1</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/basic_use.html">Using 'shapviz'</a>
    </li>
    <li>
      <a href="../articles/geographic.html">Geographic Components</a>
    </li>
    <li>
      <a href="../articles/multiple_output.html">Multiple 'shapviz' objects</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/ModelOriented/shapviz/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Geographic Components</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ModelOriented/shapviz/blob/HEAD/vignettes/geographic.Rmd" class="external-link"><code>vignettes/geographic.Rmd</code></a></small>
      <div class="hidden name"><code>geographic.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="setting">Setting<a class="anchor" aria-label="anchor" href="#setting"></a>
</h2>
<p>In a model with geographic components, we want to express a
functional <span class="math inline">\(T\)</span> (usually the
expectation or a quantile) of a response <span class="math inline">\(Y\)</span> as a function <span class="math inline">\(f\)</span> of a set of geographic features
(latitude/longitude and/or postal code and/or other features varying
with location), and other features:</p>
<p><span class="math display">\[
  T(Y \mid X^\textrm{geo}, X^\textrm{other}) \approx f(X^\textrm{geo},
X^\textrm{other})
\]</span> Like any feature, the effect of a single geographic feature
<span class="math inline">\(X^{\textrm{geo}, j}\)</span> can be
described using SHAP dependence plots. However, studying the effect of
latitude (or any other location dependent feature) alone is often not
very illuminating - simply due to strong interaction effects and
correlations with other geographic features.</p>
<p>That’s where the additivity of SHAP values comes into play: The sum
of SHAP values of all geographic components represent the total effect
of <span class="math inline">\(X^\textrm{geo}\)</span>, and this sum can
be visualized as a heatmap or 3D scatterplot against latitude/longitude
(or any other geographic representation)</p>
</div>
<div class="section level2">
<h2 id="a-first-example">A first example<a class="anchor" aria-label="anchor" href="#a-first-example"></a>
</h2>
<p>For illustration, we will use a beautiful house price dataset
containing information on about 14’000 houses sold in 2016 in Miami-Dade
County. Some of the columns are as follows:</p>
<ul>
<li>
<strong>SALE_PRC</strong>: Sale price in USD: Its logarithm will be
our model response.</li>
<li>
<em>LATITUDE</em>, <em>LONGITUDE</em>: Coordinates</li>
<li>
<em>CNTR_DIST</em>: Distance to central business district</li>
<li>
<em>OCEAN_DIST</em>: Distance (ft) to the ocean</li>
<li>
<em>RAIL_DIST</em>: Distance (ft) to the next railway track</li>
<li>
<em>HWY_DIST</em>: Distance (ft) to next highway</li>
<li>TOT_LVG_AREA: Living area in square feet</li>
<li>LND_SQFOOT: Land area in square feet</li>
<li>structure_quality: Measure of building quality (1: worst to 5:
best)</li>
<li>age: Age of the building in years</li>
</ul>
<p>(Italic features are geographic components.) For more background on
this dataset, see <span class="citation">Mayer et al. (<a href="#ref-Mayer2022MachineLA" role="doc-biblioref">2022</a>)</span>.</p>
<p>We will fit an XGBoost model to explain log(price) as a function of
lat/long, size, and quality/age.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ModelOriented/shapviz" class="external-link">shapviz</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">miami</span><span class="op">)</span></span>
<span><span class="co">#&gt;   LATITUDE LONGITUDE     PARCELNO SALE_PRC LND_SQFOOT TOT_LVG_AREA</span></span>
<span><span class="co">#&gt; 0 25.89103 -80.16056 622280070620   440000       9375         1753</span></span>
<span><span class="co">#&gt; 1 25.89132 -80.15397 622280100460   349000       9375         1715</span></span>
<span><span class="co">#&gt; 2 25.89133 -80.15374 622280100470   800000       9375         2276</span></span>
<span><span class="co">#&gt; 3 25.89176 -80.15266 622280100530   988000      12450         2058</span></span>
<span><span class="co">#&gt; 4 25.89182 -80.15464 622280100200   755000      12800         1684</span></span>
<span><span class="co">#&gt; 5 25.89206 -80.16135 622280070180   630000       9900         1531</span></span>
<span><span class="co">#&gt;   SPEC_FEAT_VAL RAIL_DIST OCEAN_DIST WATER_DIST CNTR_DIST SUBCNTR_DI HWY_DIST</span></span>
<span><span class="co">#&gt; 0             0    2815.9    12811.4      347.6   42815.3    37742.2  15954.9</span></span>
<span><span class="co">#&gt; 1             0    4359.1    10648.4      337.8   43504.9    37340.5  18125.0</span></span>
<span><span class="co">#&gt; 2         49206    4412.9    10574.1      297.1   43530.4    37328.7  18200.5</span></span>
<span><span class="co">#&gt; 3         10033    4585.0    10156.5        0.0   43797.5    37423.2  18514.4</span></span>
<span><span class="co">#&gt; 4         16681    4063.4    10836.8      326.6   43599.7    37550.8  17903.4</span></span>
<span><span class="co">#&gt; 5          2978    2391.4    13017.0      188.9   43135.1    38176.2  15687.2</span></span>
<span><span class="co">#&gt;   age avno60plus month_sold structure_quality</span></span>
<span><span class="co">#&gt; 0  67          0          8                 4</span></span>
<span><span class="co">#&gt; 1  63          0          9                 4</span></span>
<span><span class="co">#&gt; 2  61          0          2                 4</span></span>
<span><span class="co">#&gt; 3  63          0          9                 4</span></span>
<span><span class="co">#&gt; 4  42          0          7                 4</span></span>
<span><span class="co">#&gt; 5  41          0          2                 4</span></span>
<span></span>
<span><span class="va">x_coord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LATITUDE"</span>, <span class="st">"LONGITUDE"</span><span class="op">)</span></span>
<span><span class="va">x_nongeo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TOT_LVG_AREA"</span>, <span class="st">"LND_SQFOOT"</span>, <span class="st">"structure_quality"</span>, <span class="st">"age"</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x_coord</span>, <span class="va">x_nongeo</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Train/valid split</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">ix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">miami</span><span class="op">)</span>, <span class="fl">0.8</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">miami</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">miami</span><span class="op">[</span><span class="va">ix</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">X_valid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">miami</span><span class="op">[</span><span class="op">-</span><span class="va">ix</span>, <span class="va">x</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html" class="external-link">log</a></span><span class="op">(</span><span class="va">miami</span><span class="op">$</span><span class="va">SALE_PRC</span><span class="op">[</span><span class="va">ix</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">y_valid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html" class="external-link">log</a></span><span class="op">(</span><span class="va">miami</span><span class="op">$</span><span class="va">SALE_PRC</span><span class="op">[</span><span class="op">-</span><span class="va">ix</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit XGBoost model with early stopping</span></span>
<span><span class="va">dtrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html" class="external-link">xgb.DMatrix</a></span><span class="op">(</span><span class="va">X_train</span>, label <span class="op">=</span> <span class="va">y_train</span><span class="op">)</span></span>
<span><span class="va">dvalid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html" class="external-link">xgb.DMatrix</a></span><span class="op">(</span><span class="va">X_valid</span>, label <span class="op">=</span> <span class="va">y_valid</span><span class="op">)</span></span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.2</span>, objective <span class="op">=</span> <span class="st">"reg:squarederror"</span>, max_depth <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html" class="external-link">xgb.train</a></span><span class="op">(</span></span>
<span>  params <span class="op">=</span> <span class="va">params</span>, </span>
<span>  data <span class="op">=</span> <span class="va">dtrain</span>, </span>
<span>  watchlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>valid <span class="op">=</span> <span class="va">dvalid</span><span class="op">)</span>, </span>
<span>  early_stopping_rounds <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  nrounds <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/cb.print.evaluation.html" class="external-link">cb.print.evaluation</a></span><span class="op">(</span>period <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  valid-rmse:9.784245 </span></span>
<span><span class="co">#&gt; Will train until valid_rmse hasn't improved in 20 rounds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [101]    valid-rmse:0.152615 </span></span>
<span><span class="co">#&gt; [201]    valid-rmse:0.149175 </span></span>
<span><span class="co">#&gt; Stopping. Best iteration:</span></span>
<span><span class="co">#&gt; [210]    valid-rmse:0.148793</span></span></code></pre></div>
<p>Let’s first study selected SHAP dependence plots, evaluated on the
validation dataset with around 2800 observations. Note that we could as
well use the training data for this purpose, but it is a bit too
large.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">fit</span>, X_pred <span class="op">=</span> <span class="va">X_valid</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span></span>
<span>  <span class="va">sv</span>, </span>
<span>  v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TOT_LVG_AREA"</span>, <span class="st">"structure_quality"</span>, <span class="st">"LONGITUDE"</span>, <span class="st">"LATITUDE"</span><span class="op">)</span>, </span>
<span>  alpha <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="geographic_files/figure-html/unnamed-chunk-3-1.png" width="768" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># And now the two-dimensional plot of the sum of SHAP values</span></span>
<span><span class="fu"><a href="../reference/sv_dependence2D.html">sv_dependence2D</a></span><span class="op">(</span><span class="va">sv</span>, x <span class="op">=</span> <span class="st">"LONGITUDE"</span>, y <span class="op">=</span> <span class="st">"LATITUDE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="geographic_files/figure-html/unnamed-chunk-3-2.png" width="768" style="display: block; margin: auto;"></p>
<p>The last plot gives a good impression on price levels.</p>
<p>Notes:</p>
<ol style="list-style-type: decimal">
<li>Since we have modeled logarithmic prices, the effects are on
relative scale (0.1 means about 10% above average).</li>
<li>Due to interaction effects with non-geographic components, the
location effects might depend on features like living area. This is not
visible in above plot. We will modify the model now in this
respect.</li>
</ol>
</div>
<div class="section level2">
<h2 id="two-modifications">Two modifications<a class="anchor" aria-label="anchor" href="#two-modifications"></a>
</h2>
<p>We will now change above model in two ways, not unlike the model in
<span class="citation">Mayer et al. (<a href="#ref-Mayer2022MachineLA" role="doc-biblioref">2022</a>)</span>:</p>
<ol style="list-style-type: decimal">
<li>We will use additional geographic features like distance to railway
track or to the ocean.</li>
<li>We will use interaction constraints to allow only interactions
between geographic features.</li>
</ol>
<p>The second step leads to a model that is additive in each
non-geographic component and also additive in the combined location
effect. According to the technical report <span class="citation">Mayer
(<a href="#ref-mayer2022shap" role="doc-biblioref">2022</a>)</span>,
SHAP dependence plots of additive components in a boosted trees model
are shifted versions of corresponding partial dependence plots
(evaluated at observed values). This allows a “Ceteris Paribus”
interpretation of SHAP dependence plots of corresponding components.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extend the feature set</span></span>
<span><span class="va">more_geo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CNTR_DIST"</span>, <span class="st">"OCEAN_DIST"</span>, <span class="st">"RAIL_DIST"</span>, <span class="st">"HWY_DIST"</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">more_geo</span><span class="op">)</span></span>
<span></span>
<span><span class="va">X_train2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">miami</span><span class="op">[</span><span class="va">ix</span>, <span class="va">x2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">X_valid2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">miami</span><span class="op">[</span><span class="op">-</span><span class="va">ix</span>, <span class="va">x2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dtrain2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html" class="external-link">xgb.DMatrix</a></span><span class="op">(</span><span class="va">X_train2</span>, label <span class="op">=</span> <span class="va">y_train</span><span class="op">)</span></span>
<span><span class="va">dvalid2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html" class="external-link">xgb.DMatrix</a></span><span class="op">(</span><span class="va">X_valid2</span>, label <span class="op">=</span> <span class="va">y_valid</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build interaction constraint vector</span></span>
<span><span class="va">ic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">x2</span> <span class="op"><a href="https://rdrr.io/pkg/h2o/man/h2o.match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x_coord</span>, <span class="va">more_geo</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">x2</span> <span class="op"><a href="https://rdrr.io/pkg/h2o/man/h2o.match.html" class="external-link">%in%</a></span> <span class="va">x_nongeo</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Modify parameters</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">interaction_constraints</span> <span class="op">&lt;-</span> <span class="va">ic</span></span>
<span></span>
<span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html" class="external-link">xgb.train</a></span><span class="op">(</span></span>
<span>  params <span class="op">=</span> <span class="va">params</span>, </span>
<span>  data <span class="op">=</span> <span class="va">dtrain2</span>, </span>
<span>  watchlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>valid <span class="op">=</span> <span class="va">dvalid2</span><span class="op">)</span>, </span>
<span>  early_stopping_rounds <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  nrounds <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/cb.print.evaluation.html" class="external-link">cb.print.evaluation</a></span><span class="op">(</span>period <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  valid-rmse:9.784974 </span></span>
<span><span class="co">#&gt; Will train until valid_rmse hasn't improved in 20 rounds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [101]    valid-rmse:0.161874 </span></span>
<span><span class="co">#&gt; [201]    valid-rmse:0.156760 </span></span>
<span><span class="co">#&gt; Stopping. Best iteration:</span></span>
<span><span class="co">#&gt; [245]    valid-rmse:0.155253</span></span>
<span></span>
<span><span class="co"># SHAP analysis</span></span>
<span><span class="va">sv2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">fit2</span>, X_pred <span class="op">=</span> <span class="va">X_valid2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Two selected features: Thanks to additivity, structure_quality can be read as </span></span>
<span><span class="co"># Ceteris Paribus</span></span>
<span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">sv2</span>, v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"structure_quality"</span>, <span class="st">"LONGITUDE"</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="geographic_files/figure-html/unnamed-chunk-4-1.png" width="768" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Total geographic effect (Ceteris Paribus thanks to additivity)</span></span>
<span><span class="fu"><a href="../reference/sv_dependence2D.html">sv_dependence2D</a></span><span class="op">(</span><span class="va">sv2</span>, x <span class="op">=</span> <span class="st">"LONGITUDE"</span>, y <span class="op">=</span> <span class="st">"LATITUDE"</span>, add_vars <span class="op">=</span> <span class="va">more_geo</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="geographic_files/figure-html/unnamed-chunk-4-2.png" width="768" style="display: block; margin: auto;"></p>
<p>Again, the resulting total geographic effect looks reasonable. Note
that, unlike in the first example, there are no interactions to
non-geographic components, leading to a Ceteris Paribus
interpretation.</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-mayer2022shap" class="csl-entry">
Mayer, Michael. 2022. <span>“SHAP for Additively Modeled Features in a
Boosted Trees Model.”</span> <a href="https://arxiv.org/abs/2207.14490" class="external-link">https://arxiv.org/abs/2207.14490</a>.
</div>
<div id="ref-Mayer2022MachineLA" class="csl-entry">
Mayer, Michael, Steven C. Bourassa, Martin Hoesli, and Donato Flavio
Scognamiglio. 2022. <span>“Machine Learning Applications to Land and
Structure Valuation.”</span> <em>Journal of Risk and Financial
Management</em>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michael Mayer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
