---
title: "Multiple shapviz objects"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Multiple shapviz objects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  fig.height = 8, 
  fig.width = 7,
  fig.align = "center"
)
```

## Introduction

In certain situations, you will find it necessary to work with several "shapviz" objects at the same time:

1. Multiclass models fitted via XGBoost or LightGBM return SHAP values per class.
2. {kernelshap} returns SHAP values per class/response for corresponding models.
3. Compare SHAP plots of different models.
4. Study SHAP plots for different subgroups.

The [{patchwork}](https://cran.r-project.org/web/packages/patchwork) package allows to glue together the resulting plots.

To simplify the workflow, multiple "shapviz" objects can be combined together to a "mshapviz" object. This object will care about calling {patchwork}. 

## How to construct a "mshapviz" object?

There are different options:

- Use `shapviz()` on multiclass XGBoost or LightGBM models.
- Use `shapviz()` on "kernelshap" objects created from multiclass/multioutput models.
- Use `c(Mod_1 = s1, Mod_2 = s2, ...)` on "shapviz" objects `s1`, `s2`, ...
- Or `mshapviz(list(Mod_1 = s1, Mod_2 = s2, ...))`

## Example: Multiclass model

### Fit classification model

```{r}
library(xgboost)
library(ggplot2)
library(shapviz)
library(patchwork)

params <- list(objective = "multi:softprob", num_class = 3L)
X_pred <- data.matrix(iris[, -5L])
dtrain <- xgb.DMatrix(X_pred, label = as.integer(iris[, 5L]) - 1L)
fit <- xgb.train(params = params, data = dtrain, nrounds = 50L)
```

### Create "mshapviz" object

```{r}
x <- shapviz(fit, X_pred = X_pred, X = iris)
x
```
### Force plot

```{r}
sv_force(x, row_id = 101L)
```

### Summary plot

```{r}
sv_importance(x, kind = "bee") +
  plot_layout(ncol = 1L)
```

### Dependence plot

Here, we will use better class names as well as identical coordinate systems.

```{r}
names(x) <- levels(iris$Species)

sv_dependence(x, v = "Petal.Length") +
  plot_layout(ncol = 1L) & 
  xlim(1, 7) &
  ylim(-3, 4)
```


## Example: SHAP subgroup analysis

### Fit regression model

```{r}
X_pred <- data.matrix(iris[, -1L])
dtrain <- xgb.DMatrix(X_pred, label = iris[, 1L])
fit <- xgb.train(data = dtrain, nrounds = 50L)
```

### Create "mshapviz" object

```{r}
x <- shapviz(fit, X_pred = X_pred, X = iris)
x_subgroups <- c(
  setosa = x[iris$Species == "setosa"],
  versicolor = x[iris$Species == "versicolor"],
  virginica = x[iris$Species == "virginica"]
)
```

### Dependence plot

```{r}
sv_dependence(x_subgroups, v = "Petal.Length") +
  plot_layout(ncol = 1L) & 
  xlim(1, 7) &
  ylim(-1.4, 2.2)
```
