<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using {shapviz} • shapviz</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- dalexverse --><link href="../dalexverse.css" rel="stylesheet">
<link href="../dalexverse-2.css" rel="stylesheet">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using {shapviz}">
<meta property="og:description" content="shapviz">
<meta property="og:image" content="/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- google analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-5650686-14"></script><script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-5650686-14');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">shapviz</a>
        <div class="info">
          <span class="partof">part of the <a href="https://github.com/ModelOriented/DrWhy" class="external-link">DrWhy.AI</a>
           developed by the <a href="https://mi2.ai/" class="external-link">MI².AI</a> </span>
          <span class="version version-default">0.8.1</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/basic_use.html">Using {shapviz}</a>
    </li>
    <li>
      <a href="../articles/multiple_output.html">Multiple 'shapviz' objects</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/ModelOriented/shapviz/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using {shapviz}</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ModelOriented/shapviz/blob/HEAD/vignettes/basic_use.Rmd" class="external-link"><code>vignettes/basic_use.Rmd</code></a></small>
      <div class="hidden name"><code>basic_use.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>SHAP (SHapley Additive exPlanations, see <span class="citation">Lundberg and Lee (<a href="#ref-lundberg2017" role="doc-biblioref">2017</a>)</span>) is an ingenious way to study
black box models. SHAP values decompose - as fair as possible -
predictions into additive feature contributions. Crunching SHAP values
requires clever algorithms by clever people. Analyzing them, however, is
super easy with the right visualizations. {shapviz} offers the
latter:</p>
<ul>
<li>
<code><a href="../reference/sv_importance.html">sv_importance()</a></code>: Importance plots (bar plots and/or
beeswarm plots) to study variable importance.</li>
<li>
<code><a href="../reference/sv_dependence.html">sv_dependence()</a></code> and <code><a href="../reference/sv_dependence2D.html">sv_dependence2D()</a></code>:
Dependence plots to study feature effects and interactions.</li>
<li>
<code><a href="../reference/sv_interaction.html">sv_interaction()</a></code>: Interaction plots.</li>
<li>
<code><a href="../reference/sv_waterfall.html">sv_waterfall()</a></code>: Waterfall plots.</li>
<li>
<code><a href="../reference/sv_force.html">sv_force()</a></code>: Force plots as an alternative to waterfall
plots.</li>
</ul>
<p>These plots require a “shapviz” object, which is built from two
things only:</p>
<ol style="list-style-type: decimal">
<li>
<code>S</code>: Matrix of SHAP values</li>
<li>
<code>X</code>: Dataset that includes the corresponding feature
values</li>
</ol>
<p>Optionally, a <code>baseline</code> can be passed to represent an
average prediction on the scale of the SHAP values. Also a 3D array of
SHAP interaction values can be passed as <code>S_inter</code>.</p>
<p>A key feature of “shapviz” is that <code>X</code> is used for
visualization only. Thus it is perfectly fine to use factor variables,
even if the underlying model would not accept these. Additionally, in
order to improve visualization, it can sometimes make sense to clip
gross outliers, take logarithms for certain columns, or replace missing
values by some explicit value.</p>
<p>To further simplify the use of {shapviz}, we added direct connectors
to:</p>
<ul>
<li><a href="https://CRAN.R-project.org/package=xgboost" class="external-link"><code>XGBoost</code></a></li>
<li><a href="https://CRAN.R-project.org/package=lightgbm" class="external-link"><code>LightGBM</code></a></li>
<li><a href="https://CRAN.R-project.org/package=h2o" class="external-link"><code>h2o</code></a></li>
<li><a href="https://CRAN.R-project.org/package=kernelshap" class="external-link"><code>kernelshap</code></a></li>
<li><a href="https://CRAN.R-project.org/package=fastshap" class="external-link"><code>fastshap</code></a></li>
<li><a href="https://CRAN.R-project.org/package=shapr" class="external-link"><code>shapr</code></a></li>
<li><a href="https://github.com/ModelOriented/treeshap/" class="external-link"><code>treeshap</code></a></li>
<li><a href="https://CRAN.R-project.org/package=DALEX" class="external-link"><code>DALEX</code></a></li>
</ul>
<p>For XGBoost, LightGBM, and H2O, the SHAP values are directly
calculated from the fitted model.</p>
<p><a href="https://github.com/catboost/" class="external-link"><code>CatBoost</code></a> is
not included, but see Section “Any other package” how to use its SHAP
calculation backend with {shapviz}.</p>
<p>See vignette “Multiple shapviz objects” for how to deal with multiple
models or multiclass models.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># From CRAN</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"shapviz"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Or the newest version from GitHub:</span></span>
<span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"ModelOriented/shapviz"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<div class="section level3">
<h3 id="fit-model-on-diamond-prices">Fit model on diamond prices<a class="anchor" aria-label="anchor" href="#fit-model-on-diamond-prices"></a>
</h3>
<p>We start by fitting an XGBoost model to predict diamond prices based
on the four “C” features.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ModelOriented/shapviz" class="external-link">shapviz</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">3653</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Turn ordinal factors into normal ones (required for some of the examples)</span></span>
<span><span class="va">ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"clarity"</span>, <span class="st">"cut"</span>, <span class="st">"color"</span><span class="op">)</span></span>
<span><span class="va">diamonds</span><span class="op">[</span>, <span class="va">ord</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span>, <span class="va">ord</span><span class="op">]</span>, <span class="va">factor</span>, ordered <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit XGBoost model</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"carat"</span>, <span class="st">"clarity"</span>, <span class="st">"cut"</span>, <span class="st">"color"</span><span class="op">)</span></span>
<span><span class="va">dtrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html" class="external-link">xgb.DMatrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span>, label <span class="op">=</span> <span class="va">diamonds</span><span class="op">$</span><span class="va">price</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html" class="external-link">xgb.train</a></span><span class="op">(</span>params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dtrain</span>, nrounds <span class="op">=</span> <span class="fl">65</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-shapviz-object">Create “shapviz” object<a class="anchor" aria-label="anchor" href="#create-shapviz-object"></a>
</h3>
<p>One line of code creates a “shapviz” object. It contains SHAP values
and feature values for the set of observations we are interested in.
Note again that <code>X</code> is solely used as explanation dataset,
not for calculating SHAP values.</p>
<p>In this example we construct the “shapviz” object directly from the
fitted XGBoost model. Thus we also need to pass a corresponding
prediction dataset <code>X_pred</code> used for calculating SHAP values
by XGBoost.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Explanation data</span></span>
<span><span class="va">dia_small</span> <span class="op">&lt;-</span> <span class="va">diamonds</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span>, <span class="fl">2000</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">fit</span>, X_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">dia_small</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span>, X <span class="op">=</span> <span class="va">dia_small</span><span class="op">)</span></span></code></pre></div>
<p>Note: If <code>X_pred</code> would contain one-hot-encoded dummy
variables, their SHAP values (and also SHAP interaction values) could be
collapsed by the <code>collapse</code> argument of
<code><a href="../reference/shapviz.html">shapviz()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="decompose-single-prediction">Decompose single prediction<a class="anchor" aria-label="anchor" href="#decompose-single-prediction"></a>
</h3>
<p>The main idea behind SHAP values is to decompose, in a fair way, a
prediction into additive contributions of each feature. Typical
visualizations include waterfall plots and force plots:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sv_waterfall.html">sv_waterfall</a></span><span class="op">(</span><span class="va">shp</span>, row_id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-4-1.png" width="576" style="display: block; margin: auto;">
Works pretty sweet, and factor input is respected!</p>
<p>Alternatively, we can study a force plot:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sv_force.html">sv_force</a></span><span class="op">(</span><span class="va">shp</span>, row_id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-5-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Also multiple <code>row_id</code> can be passed: The SHAP values of
the selected observations are averaged and then plotted as
<strong>aggregated SHAP values</strong>: The prediction profile for
beautiful color “D” diamonds:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sv_waterfall.html">sv_waterfall</a></span><span class="op">(</span><span class="va">shp</span>, <span class="va">shp</span><span class="op">$</span><span class="va">X</span><span class="op">$</span><span class="va">color</span> <span class="op">==</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-6-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="shap-importance">SHAP importance<a class="anchor" aria-label="anchor" href="#shap-importance"></a>
</h3>
<p>We have decomposed 2000 predictions, not just one. This allows us to
study variable importance at a global model level by studying average
absolute SHAP values or by looking at beeswarm “summary” plots of SHAP
values.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A barplot of mean absolute SHAP values</span></span>
<span><span class="fu"><a href="../reference/sv_importance.html">sv_importance</a></span><span class="op">(</span><span class="va">shp</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-7-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># A beeswarm plot</span></span>
<span><span class="fu"><a href="../reference/sv_importance.html">sv_importance</a></span><span class="op">(</span><span class="va">shp</span>, kind <span class="op">=</span> <span class="st">"beeswarm"</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-7-2.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Or both!</span></span>
<span><span class="fu"><a href="../reference/sv_importance.html">sv_importance</a></span><span class="op">(</span><span class="va">shp</span>, kind <span class="op">=</span> <span class="st">"both"</span>, show_numbers <span class="op">=</span> <span class="cn">TRUE</span>, bee_width <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-7-3.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="shap-dependence-plots">SHAP dependence plots<a class="anchor" aria-label="anchor" href="#shap-dependence-plots"></a>
</h3>
<p>A SHAP beeswarm importance plot gives first hints on whether high
feature values tend to high or low predictions. This impression can be
substantiated by studying simple scatterplots of SHAP values of a
feature against its feature values.</p>
<p>On the color axis, the feature with (heuristically) strongest
interaction is shown by default. Use <code>color_var</code> to use
another feature (or <code>NULL</code> for no coloring).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">shp</span>, v <span class="op">=</span> <span class="st">"color"</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-8-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">shp</span>, v <span class="op">=</span> <span class="st">"carat"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-8-2.png" width="576" style="display: block; margin: auto;"></p>
<p>Using {patchwork}, we can also plot multiple features at the same
time.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span>  <span class="co"># to use the &amp; operator</span></span>
<span></span>
<span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">shp</span>, v <span class="op">=</span> <span class="va">x</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_gray</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">9</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5000</span>, <span class="fl">15000</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;"></p>
<p>To show the combined effects of two features (sum of their SHAP
values), 2-dimensional dependence plots are available:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sv_dependence2D.html">sv_dependence2D</a></span><span class="op">(</span><span class="va">shp</span>, x <span class="op">=</span> <span class="st">"carat"</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"clarity"</span>, <span class="st">"color"</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-10-1.png" width="576" style="display: block; margin: auto;"></p>
<p>This is especially interesting for geographic components in a
model.</p>
</div>
<div class="section level3">
<h3 id="interactions">Interactions<a class="anchor" aria-label="anchor" href="#interactions"></a>
</h3>
<p>If SHAP interaction values have been computed (via {xgboost} or
{treeshap}), the dependence plot can focus on main effects or SHAP
interaction effects (multiplied by two due to symmetry):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">shp_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, X_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">dia_small</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span>, X <span class="op">=</span> <span class="va">dia_small</span>, interactions <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">shp_i</span>, v <span class="op">=</span> <span class="st">"color"</span>, color_var <span class="op">=</span> <span class="st">"cut"</span>, interactions <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-11-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Using {patchwork}, we can show multiple colors at the same time:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">shp_i</span>, v <span class="op">=</span> <span class="st">"carat"</span>, color_var <span class="op">=</span> <span class="va">x</span>, interactions <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">6000</span>, <span class="fl">13000</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-12-1.png" width="576" style="display: block; margin: auto;"></p>
<p>We can also study all interactions and main effects together using
the following beeswarm visualization:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sv_interaction.html">sv_interaction</a></span><span class="op">(</span><span class="va">shp_i</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, vjust <span class="op">=</span> <span class="fl">1</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_use_files/figure-html/unnamed-chunk-13-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="interface-to-other-packages">Interface to other packages<a class="anchor" aria-label="anchor" href="#interface-to-other-packages"></a>
</h2>
<p>The above example uses XGBoost to calculate SHAP values. In the
following sections, we show (without running the code), how other
packages work together with {shapviz}.</p>
<div class="section level3">
<h3 id="lightgbm">LightGBM<a class="anchor" aria-label="anchor" href="#lightgbm"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Microsoft/LightGBM" class="external-link">lightgbm</a></span><span class="op">)</span></span>
<span><span class="va">dtrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lightgbm/man/lgb.Dataset.html" class="external-link">lgb.Dataset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span>, label <span class="op">=</span> <span class="va">diamonds</span><span class="op">$</span><span class="va">price</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lightgbm/man/lgb.train.html" class="external-link">lgb.train</a></span><span class="op">(</span></span>
<span>  params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.1</span>, objective <span class="op">=</span> <span class="st">"regression"</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">dtrain</span>,</span>
<span>  nrounds <span class="op">=</span> <span class="fl">65</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">fit</span>, X_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">dia_small</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span>, X <span class="op">=</span> <span class="va">dia_small</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_importance.html">sv_importance</a></span><span class="op">(</span><span class="va">shp</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fastshap">fastshap<a class="anchor" aria-label="anchor" href="#fastshap"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bgreenwell/fastshap" class="external-link">fastshap</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">Sepal.Width</span> <span class="op">+</span> <span class="va">Petal.Length</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fastshap &gt; 0.0.7 and shap_only = FALSE</span></span>
<span><span class="va">shap</span> <span class="op">&lt;-</span> <span class="fu">fastshap</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fastshap/man/explain.html" class="external-link">explain</a></span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  X <span class="op">=</span> <span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sepal.Width"</span>, <span class="st">"Petal.Length"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">100</span>, </span>
<span>  pred_wrapper <span class="op">=</span> <span class="va">predict</span>,</span>
<span>  shap_only <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">shap</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">sv</span>, <span class="st">"Sepal.Width"</span>, color_var <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fastshap &lt;= 0.0.7 or shap_only = TRUE</span></span>
<span><span class="va">shap</span> <span class="op">&lt;-</span> <span class="fu">fastshap</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fastshap/man/explain.html" class="external-link">explain</a></span><span class="op">(</span></span>
<span>  <span class="va">fit</span>, </span>
<span>  X <span class="op">=</span> <span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sepal.Width"</span>, <span class="st">"Petal.Length"</span><span class="op">)</span><span class="op">]</span>, </span>
<span>  nsim <span class="op">=</span> <span class="fl">100</span>, </span>
<span>  pred_wrapper <span class="op">=</span> <span class="va">predict</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">shap</span>, X <span class="op">=</span> <span class="va">iris</span>, baseline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">sv</span>, <span class="st">"Sepal.Width"</span>, color_var <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="shapr">shapr<a class="anchor" aria-label="anchor" href="#shapr"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://norskregnesentral.github.io/shapr/" class="external-link">shapr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">price</span> <span class="op">~</span> <span class="va">carat</span> <span class="op">+</span> <span class="va">clarity</span> <span class="op">+</span> <span class="va">cut</span> <span class="op">+</span> <span class="va">color</span>, data <span class="op">=</span> <span class="va">diamonds</span><span class="op">)</span></span>
<span><span class="va">background</span> <span class="op">&lt;-</span> <span class="va">diamonds</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span>, <span class="fl">100</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">explainer</span> <span class="op">&lt;-</span> <span class="fu">shapr</span><span class="op">(</span><span class="va">background</span>, <span class="va">fit</span><span class="op">)</span></span>
<span></span>
<span><span class="va">explanation</span> <span class="op">&lt;-</span> <span class="fu">shapr</span><span class="fu">::</span><span class="fu">explain</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">dia_small</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">200</span>, <span class="op">]</span>,</span>
<span>  approach <span class="op">=</span> <span class="st">"ctree"</span>,</span>
<span>  explainer <span class="op">=</span> <span class="va">explainer</span>,</span>
<span>  prediction_zero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">$</span><span class="va">price</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">explanation</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">shp</span>, <span class="st">"carat"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="h2o">H2O<a class="anchor" aria-label="anchor" href="#h2o"></a>
</h3>
<p>If you work with a tree-based H2O model:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/h2oai/h2o-3" class="external-link">h2o</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.init.html" class="external-link">h2o.init</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dia_h2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html" class="external-link">as.h2o</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.gbm.html" class="external-link">h2o.gbm</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"price"</span>, training_frame <span class="op">=</span> <span class="va">dia_h2o</span><span class="op">)</span></span>
<span><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">fit</span>, X_pred <span class="op">=</span> <span class="va">dia_small</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_force.html">sv_force</a></span><span class="op">(</span><span class="va">shp</span>, row_id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">shp</span>, <span class="st">"carat"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="treeshap">treeshap<a class="anchor" aria-label="anchor" href="#treeshap"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">treeshap</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/imbs-hl/ranger" class="external-link">ranger</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">ranger</span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">diamonds</span><span class="op">$</span><span class="va">price</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span>, max.depth <span class="op">=</span> <span class="fl">6</span>, num.trees <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span><span class="va">unified_model</span> <span class="op">&lt;-</span> <span class="fu">ranger.unify</span><span class="op">(</span><span class="va">fit</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">shaps</span> <span class="op">&lt;-</span> <span class="fu">treeshap</span><span class="op">(</span><span class="va">unified_model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">dia_small</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span>, interactions <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">shaps</span>, X <span class="op">=</span> <span class="va">dia_small</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_importance.html">sv_importance</a></span><span class="op">(</span><span class="va">shp</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">shp</span>, <span class="st">"carat"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span>, interactions <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="dalex">DALEX<a class="anchor" aria-label="anchor" href="#dalex"></a>
</h3>
<p>Decompositions of single predictions obtained by
<code>DALEX::predict_parts()</code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://modeloriented.github.io/DALEX/" class="external-link">DALEX</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/imbs-hl/ranger" class="external-link">ranger</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">ranger</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/delete.response.html" class="external-link">reformulate</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"price"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">diamonds</span>, max.depth <span class="op">=</span> <span class="fl">6</span>, num.trees <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">explainer</span> <span class="op">&lt;-</span> <span class="fu">DALEX</span><span class="fu">::</span><span class="fu">explain</span><span class="op">(</span><span class="va">fit</span>, data <span class="op">=</span> <span class="va">diamonds</span><span class="op">[</span><span class="va">x</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">diamonds</span><span class="op">$</span><span class="va">price</span>, label <span class="op">=</span> <span class="st">"RF"</span><span class="op">)</span></span>
<span><span class="va">breakdown</span> <span class="op">&lt;-</span> <span class="fu">predict_parts</span><span class="op">(</span><span class="va">explainer</span>, <span class="va">diamonds</span><span class="op">[</span><span class="fl">10000</span>, <span class="op">]</span>, keep_distributions <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/sv_force.html">sv_force</a></span><span class="op">(</span><span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">breakdown</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Breakdown"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="kernelshap">kernelshap<a class="anchor" aria-label="anchor" href="#kernelshap"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ModelOriented/kernelshap" class="external-link">kernelshap</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">background</span> <span class="op">&lt;-</span> <span class="va">diamonds</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">diamonds</span><span class="op">)</span>, <span class="fl">200</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">price</span> <span class="op">~</span> <span class="va">carat</span> <span class="op">+</span> <span class="va">clarity</span> <span class="op">+</span> <span class="va">cut</span> <span class="op">+</span> <span class="va">color</span>, data <span class="op">=</span> <span class="va">diamonds</span><span class="op">)</span></span>
<span><span class="va">ks</span> <span class="op">&lt;-</span> <span class="fu">kernelshap</span><span class="op">(</span><span class="va">fit</span>, <span class="va">dia_small</span><span class="op">[</span><span class="va">x</span><span class="op">]</span>, bg_X <span class="op">=</span> <span class="va">background</span><span class="op">)</span></span>
<span></span>
<span><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">ks</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_importance.html">sv_importance</a></span><span class="op">(</span><span class="va">shp</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">shp</span>, <span class="st">"carat"</span>, color_var <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="any-other-package">Any other package<a class="anchor" aria-label="anchor" href="#any-other-package"></a>
</h3>
<p>The most general interface is to provide a matrix of SHAP values and
corresponding feature values (and optionally, a baseline value):</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span>, dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">X</span>, baseline <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>An example is CatBoost: it is not on CRAN and requires
<code>catboost.*()</code> functions to calculate SHAP values, so we
cannot directly add it to {shapviz} for now. Just use a wrapper like
this:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">catboost</span><span class="op">)</span></span>
<span></span>
<span><span class="va">shapviz.catboost.Model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">X_pred</span>, <span class="va">X</span> <span class="op">=</span> <span class="va">X_pred</span>, <span class="va">collapse</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"catboost"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Package 'catboost' not installed"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span></span>
<span>    <span class="st">"X must be a matrix or data.frame. It can't be an object of class catboost.Pool"</span> <span class="op">=</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">is.matrix</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">is.data.frame</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>,</span>
<span>    <span class="st">"X_pred must be a matrix, a data.frame, or a catboost.Pool"</span> <span class="op">=</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">is.matrix</a></span><span class="op">(</span><span class="va">X_pred</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">is.data.frame</a></span><span class="op">(</span><span class="va">X_pred</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">X_pred</span>, <span class="st">"catboost.Pool"</span><span class="op">)</span>,</span>
<span>    <span class="st">"X_pred must have column names"</span> <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X_pred</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">X_pred</span>, <span class="st">"catboost.Pool"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_pred</span> <span class="op">&lt;-</span> <span class="fu">catboost.load_pool</span><span class="op">(</span><span class="va">X_pred</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">S</span> <span class="op">&lt;-</span> <span class="fu">catboost.get_feature_importance</span><span class="op">(</span><span class="va">object</span>, <span class="va">X_pred</span>, type <span class="op">=</span> <span class="st">"ShapValues"</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Call matrix method</span></span>
<span>  <span class="va">pp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X_pred</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="va">baseline</span> <span class="op">&lt;-</span> <span class="va">S</span><span class="op">[</span><span class="fl">1</span>, <span class="va">pp</span><span class="op">]</span></span>
<span>  <span class="va">S</span> <span class="op">&lt;-</span> <span class="va">S</span><span class="op">[</span>, <span class="op">-</span><span class="va">pp</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X_pred</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">S</span>, X <span class="op">=</span> <span class="va">X</span>, baseline <span class="op">=</span> <span class="va">baseline</span>, collapse <span class="op">=</span> <span class="va">collapse</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Example</span></span>
<span><span class="va">X_pool</span> <span class="op">&lt;-</span> <span class="fu">catboost.load_pool</span><span class="op">(</span><span class="va">diamonds</span><span class="op">[</span><span class="va">x</span><span class="op">]</span>, label <span class="op">=</span> <span class="va">diamonds</span><span class="op">$</span><span class="va">price</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">catboost.train</span><span class="op">(</span></span>
<span>  <span class="va">X_pool</span>, </span>
<span>  params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    loss_function <span class="op">=</span> <span class="st">"RMSE"</span>, </span>
<span>    iterations <span class="op">=</span> <span class="fl">165</span>, </span>
<span>    logging_level <span class="op">=</span> <span class="st">"Silent"</span>, </span>
<span>    allow_writing_files <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shapviz.html">shapviz</a></span><span class="op">(</span><span class="va">fit</span>, X_pred <span class="op">=</span> <span class="va">dia_small</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_importance.html">sv_importance</a></span><span class="op">(</span><span class="va">shp</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sv_dependence.html">sv_dependence</a></span><span class="op">(</span><span class="va">shp</span>, <span class="st">"clarity"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-lundberg2017" class="csl-entry">
Lundberg, Scott M, and Su-In Lee. 2017. <span>“A Unified Approach to
Interpreting Model Predictions.”</span> In <em>Advances in Neural
Information Processing Systems 30</em>, edited by I. Guyon, U. V.
Luxburg, S. Bengio, H. Wallach, R. Fergus, S. Vishwanathan, and R.
Garnett, 4765–74. Curran Associates, Inc. <a href="https://papers.nips.cc/paper/7062-a-unified-approach-to-interpreting-model-predictions.pdf" class="external-link">https://papers.nips.cc/paper/7062-a-unified-approach-to-interpreting-model-predictions.pdf</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michael Mayer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
